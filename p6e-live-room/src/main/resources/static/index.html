<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<title>抖音签名程序</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<script type="text/javascript" src="./acrawler.js"></script>
	<script type="text/javascript" src="./qm.js"></script>
</head>
<body>
	<h1>抖音签名程序</h1>
	<h2 id="date"></h2>
	<h3>不要关闭这个页面，请核对时间是否为北京时间</h3>
	<h3>当前状态: <span id="status">未连接</span></h3>
</body>
<script type="text/javascript">
		// 当前时间
    dateTime();
		setInterval(() => dateTime(), 1000);
		function dateTime() {
		    const date = new Date();
        const y = date.getFullYear();
        const m1 = date.getMonth() + 1;
        const d = date.getDate();
        const h = date.getHours();
        const m2 = date.getMinutes();
        const s = date.getSeconds();
        document.getElementById('date').innerText = y + '/' + m1 + '/' + d + ' ' + h + ':' + m2 + ':' + s;
    }

    // websocket
		const ws = new WebSocket('ws://127.0.0.1:8080/ws');
		ws.onopen = function (e) {
		    // 心跳线程
				const heartbeat = () => {
            console.log('发送 ==> {"type": "heartbeat"}');
            ws.send('{"type": "heartbeat"}')
            setTimeout(() => heartbeat(), 60000);
				}
        console.log(e);
        document.getElementById('status').innerText = '已连接';
        heartbeat();
		};

		ws.onclose = function (e) {
        console.log(e);
		    document.getElementById('status').innerText = '未连接';
		}

		ws.onerror = function (e) {
				console.log(e);
		};

		ws.onmessage = function (e) {
		    const data = String(e.data);
				console.log('收到 ==> ' + data);
				if (data.indexOf('@@@') >= 0) {
            const ds = data.split('@@@');
				    signature(ds[0], ds[1]);
				}
		};

		function signature(mark, url) {
				const xhr = new XMLHttpRequest()
				xhr.onreadystatechange = function () {
						if (xhr.readyState === 4) {
                console.log('发送 ==> ' + mark + '@@@' + xhr._url);
								ws.send(mark + '@@@' + xhr._url);
						}
				};
				xhr.open('get', url);
				xhr.send();
				xhr.abort();
		}

    const oldXMLHttpRequestSend = XMLHttpRequest.prototype.send;

		XMLHttpRequest.prototype.send = function () {
		    if (this._url !== '') {
            oldXMLHttpRequestSend.apply(this, arguments);
				}
		}

// 		// 请求拦截
//     (function () {
//
//         var onLoadStart = function (e) {
//             // console.log('onLoadStart -- ' + this);
// 				}
//
//         var onLoadEnd = function (e) {
//             // console.log('onLoadEnd -- ' + this);
//         }
//
//         var onError = function (e) {
//             // console.log('onError' + this);
//         }
//
//         // create XMLHttpRequest proxy object
//         var oldXMLHttpRequest = XMLHttpRequest;
//         // define constructor for my proxy object
//         window.XMLHttpRequest = function () {
//             var actual = new oldXMLHttpRequest();
//             var self = this;
//             this.onreadystatechange = null;
//             // this is the actual handler on the real XMLHttpRequest object
//             actual.onreadystatechange = function () {
//                 if (this.readyState == 1) {
//                     onLoadStart.call(this);
//                 } else if (this.readyState == 4) {
//                     if(this.status==200)
//                         onLoadEnd.call(this);
//                     else{
//                         onError.call(this);
//                     }
//                 }
//                 if (self.onreadystatechange) {
//                     return self.onreadystatechange();
//                 }
//             };
//
// // add all proxy getters
//             ["status", "statusText", "responseType", "response",
//                 "readyState", "responseXML", "upload"
//             ].forEach(function (item) {
//                 Object.defineProperty(self, item, {
//                     get: function () {
//                         return actual[item];
//                     },
//                     set: function (val) {
//                         actual[item] = val;
//                     }
//                 });
//             });
// // add all proxy getters/setters
//             ["ontimeout, timeout", "withCredentials", "onload", "onerror", "onprogress"].forEach(function (item) {
//                 Object.defineProperty(self, item, {
//                     get: function () {
//                         return actual[item];
//                     },
//                     set: function (val) {
//                         actual[item] = val;
//                     }
//                 });
//             });
// // add all pure proxy pass-through methods
//             ["addEventListener", "send", "open", "abort", "getAllResponseHeaders",
//                 "getResponseHeader", "overrideMimeType", "setRequestHeader", "removeEventListener"
//             ].forEach(function (item) {
//                 Object.defineProperty(self, item, {
//                     value: function () {
//                         if (item === 'send' && actual._url === '') {
// 												} else {
//                             return actual[item].apply(actual, arguments);
// 												}
//                     }
//                 });
//             });
//
//         }
//     })();


</script>
</html>
